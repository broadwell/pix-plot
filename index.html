<!DOCTYPE html>
<html>
  <head>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,600' rel='stylesheet'>
    <link rel='stylesheet' type='text/css' href='assets/css/style.css'>
    <title>Visualizing Image Fields</title>
    <meta charset='utf-8'/>
    <meta name='author' content='Douglas Duhaime'>
  </head>
  <body>
    <script type='x-shader/x-vertex' id='vertex-shader'>
    /**
    * The vertex shader's main() function must define `gl_Position`,
    * which describes the position of each vertex in screen coordinates.
    *
    * To do so, we can use the following variables defined by Three.js:
    *   attribute vec3 position - stores each vertex's position in world space
    *   attribute vec2 uv - sets each vertex's the texture coordinates
    *   uniform mat4 projectionMatrix - maps camera space into screen space
    *   uniform mat4 modelViewMatrix - combines:
    *     model matrix: maps a point's local coordinate space into world space
    *     view matrix: maps world space into camera space
    *
    * `attributes` can vary from vertex to vertex and are defined as arrays
    *   with length equal to the number of vertices. Each index in the array
    *   is an attribute for the corresponding vertex. Each attribute must
    *   contain n_vertices * n_components, where n_components is the length
    *   of the given datatype (e.g. for a vec2, n_components = 2; for a float,
    *   n_components = 1)
    * `uniforms` are constant across all vertices
    * `varyings` are values passed from the vertex to the fragment shader
    *
    * For the full list of uniforms defined by three, see:
    *   https://threejs.org/docs/#api/renderers/webgl/WebGLProgram
    **/

    #version 100
    #define SHADER_NAME instancedVertex
    #define SELECTING

    // set float precision
    precision highp float;

    uniform mat4 modelViewMatrix;
    uniform mat4 projectionMatrix;
    uniform vec3 cameraPosition;
    uniform float transitionPercent;
    uniform float pointScale;
    uniform float useColor;

    attribute vec3 position;      // base x y z position for all points
    attribute vec3 translation;   // x y z position offsets for an instance
    attribute vec3 target;        // x y z position to which we're transitioning
    attribute vec2 textureSize;   // w h percents of the cell's texture size
    attribute float textureIndex; // index of an instance's texture
    attribute vec2 textureOffset; // offset of the texture coords for an instance
    attribute float size;         // size of each side of the current instance
    attribute vec3 color;         // unique color for cell; used for raycasting
    attribute float opacity;      // opacity value for cell

    varying float vTextureIndex;  // cell texture idx (varyings can't be int)
    varying vec2 vTextureOffset;  // cell texture offset
    varying vec2 vTextureSize;    // cell texture size (in w h percents)
    varying vec2 vCellSize;       // cell size
    varying vec3 vColor;          // cell color
    varying float vOpacity;       // cell opacity

    float scalePointZ(in vec4 pos, in vec3 cameraPosition) {
      float zDelta = pow(pos[2] - cameraPosition[2], 2.0);
      float delta  = pow(zDelta, 0.5);
      float scaled = pointScale / delta;
      return scaled;
    }

    void main() {
      // pass varyings to fragment shader
      vTextureIndex = textureIndex;
      vTextureSize = textureSize;
      vTextureOffset = textureOffset;
      vCellSize = vec2(size, size);
      vColor = color;
      vOpacity = opacity;

      // set point position as a mixture between the position + target
      vec3 currentPos = position + translation;
      vec3 targetPos = position + target;
      vec3 pos = mix(currentPos, targetPos, clamp(transitionPercent, 0.0, 1.0));
      vec4 mvPos = modelViewMatrix * vec4(pos, 1.0);
      gl_Position = projectionMatrix * mvPos;

      // use the unscaled point position and camera position to set point size
      gl_PointSize = scalePointZ(mvPos, cameraPosition);
    }
    </script>

    <script type='x-shader/x-fragment' id='fragment-shader'>
    /**
    * The fragment shader's main() function must define `gl_FragColor`,
    * which describes the pixel color of each pixel on the screen.
    *
    * To do so, we can use uniforms passed into the shader and varyings
    * passed from the vertex shader.
    *
    * Attempting to read a varying not generated by the vertex shader will
    * throw a warning but won't prevent shader compiling.
    **/

    #version 100
    #define SHADER_NAME instancedFragment
    #define SELECTING

    precision highp float;

    // textures contains an array of sampler2Ds
    #ifndef SELECTING
      uniform sampler2D textures[N_TEXTURES];
      uniform sampler2D lodTexture;
    #endif
    uniform float useColor;

    varying float vTextureIndex; // cell's texture index
    varying vec2 vTextureSize;   // cell's texture w, h {0:1}
    varying vec2 vTextureOffset; // cell's uv offsets in the texture
    varying vec2 vCellSize;      // cell's size
    varying vec3 vColor;         // cell's color
    varying float vOpacity;      // cell's opacity

    void main() {
      // width and height margins for texture size
      float wMargin = (1.0 - vTextureSize[0]) / 2.0;
      float hMargin = (1.0 - vTextureSize[1]) / 2.0;
      if (
        gl_PointCoord.x < wMargin ||
        gl_PointCoord.x > (vTextureSize[0] + wMargin)) {
        discard;
      } else if (
        gl_PointCoord.y < hMargin ||
        gl_PointCoord.y > (vTextureSize[1] + hMargin)) {
        discard;
      } else if (vOpacity < 0.5) {
        discard;
      }

      if (useColor == 1.) {
        gl_FragColor = vec4(vColor, 1.0);
      } else {
        int textureIndex = int(vTextureIndex);
        vec2 uv = vTextureOffset + vec2(gl_PointCoord.x, gl_PointCoord.y);
        vec2 scaledUv = uv * vCellSize;
        TEXTURE_LOOKUP_TREE
      }
    }
    </script>

    <!-- Worker -->
    <script type='script/worker' id='worker'>
    self.onmessage = function(event) {
      self.workerIndex = event.data.workerIndex;
      if (event.data.message == 'load') {
        self.url = event.data.url;
        self.get(self.url, self.onSuccess, self.onErr)
      }
    };

    self.onSuccess = function(data) {
      // window.caches is a global store of web worker data
      caches.open(self.url).then(function(cache) {
        return cache.add(data);
      })

      self.postMessage({
        status: 'complete',
        workerIndex: self.workerIndex,
        url: self.url,
      })
    }

    self.onErr = function() {
      self.postMessage({
        status: 'error',
        workerIndex: self.workerIndex,
      })
    }

    self.onProgress = function(e) {
      self.postMessage({
        status: 'progress',
        workerIndex: self.workerIndex,
        loadPercent: e.loaded/e.total,
      })
    }

    self.get = function(url, success, err) {
      var xmlhttp = new XMLHttpRequest();
      xmlhttp.onreadystatechange = function() {
        if (xmlhttp.readyState == XMLHttpRequest.DONE) {
          xmlhttp.status === 200
            ? success(xmlhttp.responseText)
            : err(xmlhttp);
        };
      };
      xmlhttp.onprogress = self.onProgress;
      xmlhttp.open('GET', url, true);
      xmlhttp.send();
    }
    </script>

    <!-- Header -->
    <header class='header'>
      <img class='logo' src='assets/images/dhlab-logo.svg' alt='DHLab logo' />
      <div class='app-name'>PixPlot</div>
      <div class='tagline'>Image fields in a Local Collection</div>
      <div class='header-controls'>
        <div class='filter-icons' id='filters'></div>
      </div>
    </header>
    <!-- Loader -->
    <div id='loader-scene'>
      <p class='welcome'>This page visualizes a large image collection within an interactive WebGL scene. Each image was processed with an <a href='https://www.cs.unc.edu/~wliu/papers/GoogLeNet.pdf' target='_blank'>Inception</a> Convolutional Neural Network, trained on <a href='http://image-net.org/challenges/LSVRC/2012/' target='_blank'>ImageNet 2012</a>, and projected into a two-dimensional manifold with the <a href='https://github.com/lmcinnes/umap' target='_blank'>UMAP</a> algorithm such that similar images appear proximate to one another.</p>
      <div class='loader-container'>
        <div class='loader-icon'>
          <div class='blocks'>
            <div class='block'></div>
            <div class='block'></div>
            <div class='block'></div>
            <div class='block'></div>
            <div class='block'></div>
            <div class='block'></div>
            <div class='block'></div>
            <div class='block'></div>
            <div class='block'></div>
          </div>
        </div>
        <div id='loader-text'>
          <span id='progress'>0%</span>
        </div>
      </div>
      <button id='enter-button'>Enter</button>
    </div>
    <!-- Canvas -->
    <div id='canvas-container'>
      <div id='canvas-target'></div>
    </div>
    <!-- Hotspot Navigation -->
    <nav>
      <div class='nav-inner'>
        <h2>Hotspots</h2>
        <div id='hotspots'></div>
        <script type='text/html' id='hotspot-template'>
          <% _.forEach(hotspots, function(hotspot) { %>
            <div class='hotspot'>
              <div class='background-image'
                style='background-image: url("output/thumbs/128px/<%= hotspot.img %>")'></div>
              <div><%= hotspot.label %></div>
            </div>
          <% }); %>
        </script>
      </div>
    </nav>
    <!-- Selected Image -->
    <div id='selected-image-modal'>
      <div class='backdrop'></div>
      <div class='modal-image-sizer'>
        <div class='modal-content'>
          <div id='close-modal'></div>
          <img id='selected-image' />
          <div class='icons'>
            <a target='_blank' id='eye-icon'>
              <img src='assets/images/icons/eye-icon.png' />
            </a>
            <a id='download-icon'>
              <img src='assets/images/icons/download-icon.png' />
            </a>
            <a id='copyright-icon' href='#'>
              <img src='assets/images/icons/copyright-icon.png' />
            </a>
          </div>
        </div>
      </div>
    </div>
    <!-- Selected Image Metadata -->
    <div id='selected-image-meta'>
      <div class='meta-content'>
        <div class='meta-left'>
          <div id='image-title'>Full Image Title Here</div>
          <div id='image-text'>There are many variations of passages of Lorem Ipsum available, but the majority have suffered alteration in some form, by injected humour, or randomised words which don't look even slightly believable. If you are going to use a passage of Lorem Ipsum, you need to be sure there isn't anything embarrassing hidden in the middle of text.</div>
        </div>
        <div class='meta-right'>
          <script type='text/html' id='tag-template'>
            <% _.forEach(tags, function(tag) { %>
              <div class='meta-tag'><%- tag %></div>
            <% }); %>
          </script>
          <div id='meta-tags'></div>
          <div class='meta-input-container'>
            <input id='meta-input' placeholder='New tags' />
            <div id='meta-input-add'>Add</div>
            <div class='pencil-icon'></div>
          </div>
        </div>
      </div>
    </div>
    <!-- Webgl / Noscript Warnings -->
    <div id='webgl-not-available'>
      <div class='browser-message'>Sorry, your browser is not able to load a WebGL scene currently. Please check your browser settings and try again.</div>
    </div>
    <noscript>
      <span class='browser-message'>Sorry, your browser is not able to load a WebGL scene currently. Please enable JavaScript and try again.</span>
    </noscript>
    <script type='text/javascript' src='assets/vendor/dist/three.min.js'></script>
    <script type='text/javascript' src='assets/vendor/dist/lodash.min.js'></script>
    <script type='text/javascript' src='assets/js/object-assign-polyfill.js'></script>
    <script type='text/javascript' src='assets/vendor/dist/tweenlite.min.js'></script>
    <script type='text/javascript' src='assets/vendor/dist/trackball-controls.min.js'></script>
    <script type='text/javascript' src='assets/vendor/dist/texture-loader.min.js'></script>
    <script type='text/javascript' src='assets/vendor/dist/stats.min.js'></script>
    <script type='text/javascript' src='assets/js/tsne.js'></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-101732875-1', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>
